
// $TX+IV,"       This Is Bull!ts       "$   ÛÛÛ   ÛÛÛ
//                                Û±±ÛÛ ÛÛÛÛÛ
// Bullet Hell game for TempleOS. Û±ÛÛÛÛÛÛÛÛÛ
// By Rendello, September 2020.   ÛÛÛÛÛÛÛÛÛÛÛ  
//                                Û±ÛÛÛÛÛÛ±±Û  ±±
// Under BSD-3 licence, see readme.ÛÛÛÛÛÛ± ±± ±±±±
// If you modify and re-release     ÛÛÛÛÛ±±±±±±±±±
// it, please change the title       ÛÛÛÛÛ±±±±±±±
// and credit the original.           ÛÛÛ  ±±±±±
//                                     Û    ±±±
// Enjoy!                                    ±



// $TX+IV,"      General options     "$

#define FANCY_GRAPHICS	ON
#define PROFILER	OFF

Cd(__DIR__);;
#include "BH_II.HH";


// $TX+IV,"                                             "$
// $TX+IV,"     Declare / init match-agnostic state     "$
// $TX+IV,"                                             "$

// None of this has to be changed or reset
// between matches.

CTask *task=Fs;
CDC *dc=DCAlias;
CDC *dc_2=DCAlias;
//dc->flags|=DCF_TRANSFORMATION;

CDateStruct ds;

I64 i, j;

Bool debug=OFF;
Bool draw_jet=ON;
Bool fancy_graphics=OFF;

// (Where the left-click quick stats go.)
I64 stat_align_left;
I64 stat_align_right;


// $TX+IV," Initialize top scores "$
// The top_scores array is of size TOP_SCORES_NUM + 1
// as at the end of a match, the current score is
// appended and the array is once again QSorted.
// The new top ten scores are stored to the save file.
RegDft("Rendello/Bull!ts",
	"Score top_scores[11]={{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0},{0,0}}");

RegExe("Rendello/Bull!ts");



// $TX+IV,"                                      "$
// $TX+IV,"     Declare match-specific state     "$
// $TX+IV,"                                      "$

// All values will be initialized in Init().
// See Init() for details on each value.

U8 scoreboard_string[6];

Enemy enemies[ENEMY_NUM];
Bullet bullets[BULLET_ARRAY_SIZE];
I64 bullet_count;

I64 graph_buf[255];

Bool current_score_drawn;
I64 frame;
I64 draw_frame;
F64 old_ms_x;
F64 rotation;

Match match;
Player player;
Score current_score;


U0 Init() {
  // Initializes (prev. declared) state for a new match.
  // Most game state must be global, in order to be used
  // by the draw (Fs->draw_it) and logic (Fs->animate_task)
  // callbacks.

  // $TX+IV," Init enemies "$
  enemies[0].x=1;

  for (i=0;i<ENEMY_NUM;i++) {
    enemies[i].x = RandRangeI64(CANV_X_START,CANV_X_END);
    enemies[i].y = RandRangeI64(INIT_SPAWN_HEIGHT,0);
    enemies[i].original_x = enemies[i].x;
    enemies[i].sway_multiplier = RandRangeI64(
  	ENEMY_SWAY_LOWER_BOUND, ENEMY_SWAY_UPPER_BOUND);
  }


  // $TX+IV," Init bullets "$
  // Inactive bullets are stored off-screen.
  // Each fired bullet increases the bullet_count
  // and occupies its index in the array. bullet_count
  // loops back to 0 after hitting BULLET_ARRAY_SIZE.
  bullet_count = 0;
  for (i=0;i<BULLET_ARRAY_SIZE;i++) {
    ResetBullet(bullets,i);
  }

  // $TX+IV," Init ship rotation "$
  old_ms_x=ms.pos.x;
  rotation=0;

  // $TX+IV," Init frame count "$
  frame = 0;
  draw_frame = 0;

  // $TX+IV," Init graph buffer "$
  for (i=0;i<255;i++) {
    graph_buf[i] = 0;
  }

  // $TX+IV," Init match "$
  match.spawn_height = INIT_SPAWN_HEIGHT;
  match.spawn_tolerence = INIT_SPAWN_HEIGHT - 1000;
  match.start_time = tS;
  match.time = tS;
  match.big_bullet_interval = 30;

  // $TX+IV," Init player "$
  player.x = 100;
  player.y = 100;
  player.health = MAX_HEALTH;
  player.invincibility_frames = 0;
  player.last_hit_time = 0;

  // $TX+IV," Init current score "$
  current_score.match_time = match.time;
  current_score.date = "Right now!";
}


U0 PaletteInit() {
  // Changes the palette to the game version. If palette
  // shifting is enabled, most of the changes won't be
  // visible.
}

Init();


// $TX+IV," Bullet palette-swap data "$
I64 bullet_color_steps = 85;
I64 bullet_color_num = (bullet_color_steps*2)-2;
CBGR48 bullet_colors[bullet_color_num];

InterpolateColors(bullet_colors,bullet_color_steps,0xff0033000000,
	0xff00cc000000,TRUE);


// $TX+IV," New palette "$
// See new color #defines at the top of file.

GrPaletteColorSet(LTGRAY_NS,GrPaletteColorGet(LTGRAY));


// $TX+IV," Sidebar image palette-swap data "$
CBGR48 ltgray_color=0xd400cf00c700;
GrPaletteColorSet(SB_IMG_GRAY,ltgray_color);

I64 frame_color_steps = 85;
I64 frame_color_num = (frame_color_steps*2)-2;
CBGR48 frame_colors[frame_color_num];


InterpolateColors(frame_colors,frame_color_steps,ltgray_color,
	0xff0022001100,TRUE);



if (PROFILER) { Prof; }



// $TX+IV,"                          "$
// $TX+IV,"     Drawing callback     "$
// $TX+IV,"                          "$

F64 draw_time_start;

U0 Draw(CTask *task, CDC *) {
  draw_time_start=tS;

  DCFill;

  // $TX+IV," Palette-shift bullets "$
  // Bullets have two colors, one is always behind the other
  // by approx. half the steps.

  # if (FANCY_GRAPHICS)
    GrPaletteColorSet(PURPLE,bullet_colors[frame%bullet_color_num]);
    GrPaletteColorSet(LTPURPLE,bullet_colors[(frame+bullet_color_steps)%bullet_color_num]);
  # endif

  // $TX+IV," Palette-shift sidebar image "$
  if (player.health >= 3) {
    GrPaletteColorSet(SB_IMG_BG,0xff00cc000000);
  } else {
    GrPaletteColorSet(SB_IMG_BG,GrPaletteColorGet(PURPLE));
    GrPaletteColorSet(SB_IMG_GRAY,ltgray_color);

    if (player.health <= 1) {
      GrPaletteColorSet(SB_IMG_GRAY,frame_colors[frame%frame_color_num]);
    }
  }



 /*
  DCFill(dc,DKGRAY);
  for (i=CANV_X_END;i>0;i-=6) {
    if (!(i&2)) {
      dc->color=BUL_BG_1;
    } else {
      dc->color=YELLOW;
    }
    GrFillCircle(
      dc,
      Sin(tS/3)*(i&15)+CANV_X_MID,
      Sin(tS/4)*(i&15)+CANV_X_MID,
      ,
      ToI64(i+match.time)
     );
  }
  */


  // $TX+IV," Screen-shake on hit "$
  if (player.invincibility_frames > 50) {
    dc->x=RandRangeI64(-5,5);
    dc->y=RandRangeI64(-5,5);
  } else {
    dc->x=0;
    dc->y=0;
  }

  // $TX+IV," Draw enemies "$
  for (i=0; i<ENEMY_NUM;i++) {
    if (enemies[i].y > -10) {
      dc->color=GREEN;
      GrFillCircle(dc,enemies[i].x,enemies[i].y,,20);
    }
  }

  // $TX+IV," Update player position "$
  // NOTE: Updating state inside the draw loop
  // isn't great, but the player position will
  // lag by one frame if updated in the main loop,
  // which is bad for this type of game.
  player.x = Clamp(ms.pos.x,ToF64(CANV_X_START),ToF64(CANV_X_END-10));
  player.y = Clamp(ms.pos.y,CANV_Y_START,CANV_Y_END);

  if (ms.pos.x > CANV_X_END) gr.fp_draw_ms=&DrawStdMs;
  else gr.fp_draw_ms=&MsDrawNothing;

  // $TX+IV," Draw jet "$
  if (draw_jet) {
    // Calculate jet rotation
    if (ms.pos.x-old_ms_x != 0) {
      rotation=Clamp(rotation+ToF64(ms.pos.x-old_ms_x)/100,-1,1);
    } else {
      rotation -= rotation/10;
    }
    JetDraw(dc_2,player.x+4,player.y-4,rotation);
  }

  // $TX+IV," Draw player dot(s) "$
  dc->color=BLUE;
  // Blink on invincibility frames
  if (player.invincibility_frames !=0 &&
	player.invincibility_frames % 4 == 0) {
    // (NO-OP; Don't draw player).
  } else {
     // (Keep player dot legible w/ or w/o jet.)
     if (draw_jet) {
       dc->color = WHITE;
     } else {
       dc->color = BLUE;
     }
     GrFillCircle(dc,player.x+4,player.y-4,,10);
     dc->color = LTBLUE;
     GrFillCircle(dc,player.x+4,player.y-4,,6);

  }

  for (i=0;i<BULLET_ARRAY_SIZE;i++) {
    // $TX+IV," Draw bullet "$
    // Two colored circles, see palette-shift above.
    // Half of the bullets have a 'dark' middle and 'light' border,
    // the other half is the opposite. It gives the palette-shifting
    // bullets more visual variety.

    if (bullets[i].x > -10) {
      if (i%2==0) {
        dc->color=BUL_BG_1;
      } else {
        dc->color=BUL_BG_2;
      }
      GrFillCircle(dc,bullets[i].x,bullets[i].y,,bullets[i].diameter<<1);
      if (i%2==0) {
        dc->color=BUL_BG_2;
      } else {
        dc->color=BUL_BG_1;
      }
      GrFillCircle(dc,bullets[i].x,bullets[i].y,,bullets[i].diameter+1);
    }
  }

  // $TX+IV," Show stats when player left-clicks "$
  dc->color=BLACK;

  if (ms.lb) {
    if (draw_jet) {
      stat_align_left = player.x - 68;
      stat_align_right = player.x + 38;
    } else {
      stat_align_left = player.x - 48;
      stat_align_right = player.x + 15;
    }

    GrPrint(dc,stat_align_left,player.y-7,"%5.1f",match.time);
    dc->color=GREEN;

    GrPrint(dc,stat_align_right,player.y-7,"%d",player.health);
    if (player.health < 3) {
      dc->color=LTBLUE;
      GrPrint(dc,stat_align_right,player.y+2,"%-3.1f",REGEN_TIME - (match.time - player.last_hit_time));
    }
  }

  // $TX+IV," Draw sidebar background "$
  dc->color=DKGRAY;
  GrRect3(dc,CANV_X_END,0,0,GR_WIDTH,GR_HEIGHT); // Sidebar (right).


  // $TX+IV," Draw frame "$
  BorderDraw(dc, 0, 0, CANV_X_START+CANV_X_END-2,
	CANV_Y_START+CANV_Y_END, 5, LTGRAY_NS, DKGRAY);


  // $TX+IV," Draw sidebar image "$
  Sprite3(dc,CANV_X_END+3,4,0,$IB,"<1>",BI=1$,TRUE);


  // $TX+IV," Draw dot-matrix timer "$
  if (player.invincibility_frames > 0) {
    if (player.invincibility_frames&0b1000==0) {
      StrPrint(scoreboard_string,"OUCH!");
    } else {
      StrPrint(scoreboard_string,"");
    }
  } else if (player.health > 0) {
    StrPrint(scoreboard_string,"%5.1f",match.time);
  } else {
    if (ToI64(tS*100)&0b10000 != 0) {
    if (Blink(0.3)) {
      if (!Blink(0.6)) {
         StrPrint(scoreboard_string,"GAME");
       } else {
        StrPrint(scoreboard_string,"OVER!");
      }
    } else {
      StrPrint(scoreboard_string,"%5.1f",match.time);
    }
    } else {
      StrPrint(scoreboard_string,"");
    }
  }

  dc->color=BLACK;
  GrRect3(dc,CANV_X_END+5,255,0,166,40);

  dc->color=LTGRAY_NS;
  DotMatrix(dc,CANV_X_END+20,260,6,5,scoreboard_string);

  // $TX+IV," Draw health "$
  dc->color=LTGRAY_NS;
  GrPrint3(dc,CANV_X_END+6,300,0,"PWR");


  CBGR48 sheen_color;
  for (i=0;i<MAX_HEALTH;i++) {
    if (i < player.health) {
      dc->color=GREEN;
      sheen_color=LTGREEN;
    } else {
      dc->color=LTPURPLE;
      sheen_color=YELLOW;
    }
    GrRect3(dc,CANV_X_END+6,310+(i*19),0,30,13);
    BorderDraw(dc, CANV_X_END+6, 310+(i*19),30,14,2,sheen_color,LTGRAY_NS);
  }

  // $TX+IV," Draw regen status "$
  if (player.health != 3) {
    dc->color=BLACK;
    GrRect3(dc,CANV_X_END+40,310,0,10,REGEN_TIME);  

    dc->color=GREEN;
    GrRect3(dc,CANV_X_END+40,310,0,10,match.time - player.last_hit_time);
  } else {
    // TODO Remove this hack
    dc->color=BLUE;
    GrRect3(dc,CANV_X_END+40,310,0,10,REGEN_TIME);
  }

  // $TX+IV," Draw top scores table "$
  // Current score shown in PURPLE, knocks lower scores off
  // the board.

  dc->color=LTGRAY_NS;
  GrPrint3(dc,CANV_X_END+130,300,0,"TOP");

  dc->color=BLACK;
  GrRect3(dc,CANV_X_END+128,308,0,44,102);

  current_score_drawn=FALSE;
  for (i=0;i<TOP_SCORES_NUM;i++) {
    if (top_scores[i].match_time < current_score.match_time &&
	!current_score_drawn) {
      dc->color=PURPLE;
      GrPrint3(dc,CANV_X_END+130,311+(i*10),0,"%5.1f", \
		current_score.match_time, current_score.date);
      current_score_drawn=TRUE;
    }
    dc->color=GREEN;
    if (!(current_score_drawn && i==TOP_SCORES_NUM-1)) {
      GrPrint3(dc,CANV_X_END+130,311+((current_score_drawn+i)*10),0, \
		"%5.1f",top_scores[i].match_time,top_scores[i].date);
    }
  }

  // $TX+IV," Draw game info "$
  dc->color=LTGRAY_NS;
  GrPrint3(dc,CANV_X_END+5,461,0,"TiB 1.0.0b   Rendello");

  // $TX+IV," Draw game border "$
  BorderDraw(dc, CANV_X_END+3, 254, 167, 43, 2, LTGRAY,BLUE);

  // $TX+IV," Draw debug "$
  if (debug) {
    dc->color=BLUE;
    GrPrint(dc,CANV_X_START+10,CANV_Y_START+10,
	"Max spawn height (pix): %d",match.spawn_height);
    GrPrint(dc,CANV_X_START+10,CANV_Y_START+20,
	"Approx. draw time (ms): %6.3f",(tS-draw_time_start)*1000);
    GrPrint(dc,CANV_X_START+10,CANV_Y_START+30,
	"Big bullet ratio: úúúúú 1:%d",match.big_bullet_interval-1);
    if (draw_jet) {
      GrPrint(dc,CANV_X_START+10,CANV_Y_START+40,
	"Jet rotation: úúúúúúúúú %5.3f",rotation);
    }
  }

  // $TX+IV," Draw graph "$
  if (debug) {
    Graph(dc, graph_buf, 10, 100, draw_frame, (tS-draw_time_start)*3000);
  }

  
  old_ms_x = ms.pos.x; // For jet rotation.
  draw_frame++;
}


// $TX+IV,"              "$
// $TX+IV,"     Main     "$
// $TX+IV,"              "$

U0 GameUpdate() {

}

U0 Main() {
  AutoComplete;
  WinBorder;
  WinMax;
  DocCursor;
  DocClear;
  Fs->draw_it=&Draw;

  F64 frame_time_start;

  F64 dx;
  F64 dy;

  I64 ch,sc; // char, scan code

  F64 esc_timer_start=0;
  match.start_time=tS;

  // For setting bullet velocity
  F64 speed;
  F64 distance;

  while (TRUE) {
    // $TX+IV," NOTE! "$
    // Player position update code is in the draw loop.


    // $TX+IV," Exit on Esc "$
    // It also occurs on double left or right click,
    // which are synonymous with esc and shift-esc.
    // This is a TempleOS thing.

    if (ScanKey(&ch,&sc)) {
      switch (ch) {
	case 0:
	  switch (sc.u8[0]) {
	    case SC_CURSOR_LEFT:
	      //ms.pos.x-=10;
              MsSet(ms.pos.x-10,ms.pos.y); // TODO MsSet for all
	      break;
	    case SC_CURSOR_RIGHT:
	      ms.pos.x+=10;
	      break;
	    case SC_CURSOR_UP:
              ms.pos.y-=10;
	      break;
	    case SC_CURSOR_DOWN:
              ms.pos.y+=10;
	      break;
	  }
	  break;
	case '\n':
	  break; // Todo new match
	case CH_SHIFT_ESC:
	case CH_ESC:
	  goto main_loop_end;
	case 'Z':
	case 'z':
          debug = Toggle(debug);
          break;
	case 'X':
	case 'x':
          draw_jet = Toggle(draw_jet);
          break;

        default: break;
      }
    }

    // $TX+IV," Update total match time + start frame time "$
    frame_time_start = tS;
    if (player.health > 0) {
      match.time = tS - match.start_time;
    }
    current_score.match_time = match.time;

    // $TX+IV," Fire towards player"$
    // Bullets are shot by all enemies simultaniously.
    for (i=0;i<ENEMY_NUM;i++) {
      if (frame % ENEMY_FIRE_COOLDOWN == 0 &&
          CANV_Y_START < enemies[i].y < CANV_Y_END) {


        bullets[bullet_count].x = enemies[i].x;
        bullets[bullet_count].y = enemies[i].y;

        if (bullet_count % match.big_bullet_interval == 0) {
          bullets[bullet_count].diameter = BULLET_DIAMETER*2.5;
          speed=1.3;
        } else {
          bullets[bullet_count].diameter = BULLET_DIAMETER;
          speed=1.5;
        }

        distance = Sqrt((player.x - enemies[i].x)`2 +
		(player.y - enemies[i].y)`2);

        bullets[bullet_count].vel_x = speed*((player.x-enemies[i].x)/distance);
        bullets[bullet_count].vel_y = speed*((player.y-enemies[i].y)/distance);
      
        // (Simple circular buffer, see init.)
        bullet_count = (bullet_count + 1) % BULLET_ARRAY_SIZE;
      }

      if (enemies[i].y > GR_HEIGHT+10) {

        // $TX+IV," Reset enemy if below screen "$
        enemies[i].x = RandRangeI64(CANV_X_START,CANV_X_END);
        enemies[i].y = RandRangeI64(-match.spawn_height,0);
      } else {

        // $TX+IV," Sway enemy (if onscreen) & move it downward "$
        if (enemies[i].y > -10) {
          enemies[i].x = Sin(enemies[i].y/40.0)*enemies[i].sway_multiplier \
		+enemies[i].original_x;
        }
        enemies[i].y+=ENEMY_DOWN_SPEED;
      }
    }

    for (i=0;i<BULLET_ARRAY_SIZE;i++) {

      // $TX+IV," Check collision with player "$
      // It's lenient and only checks half the player's radius.
      if (bullets[i].x > 0) {
        dx = bullets[i].x - player.x;
        dy = bullets[i].y - player.y;

        if (Sqrt(dx * dx + dy * dy) < (bullets[i].diameter + (PLAYER_RADIUS>>1)) &&
		player.invincibility_frames == 0) {
          ResetBullet(bullets,i);
          player.health--;
          player.invincibility_frames = 100;
          player.last_hit_time = match.time;
        }
      }

      if (bullets[i].x < CANV_X_START-20 ||
          bullets[i].x > CANV_X_END+20	 ||
          bullets[i].y < CANV_Y_START-20 ||
          bullets[i].y > CANV_Y_END+20) {
        // $TX+IV," Reset out-of-bounds bullets "$
        ResetBullet(bullets,i);
      } else {
        // $TX+IV," Move bullets by their velocity "$
        bullets[i].x += bullets[i].vel_x;
        bullets[i].y += bullets[i].vel_y;
      }
    }

    // $TX+IV," Decrement invincibility frames "$
    if (player.invincibility_frames != 0) {
      player.invincibility_frames--;
    }

    // $TX+IV," Reduce enemy spawn height "$
    // The spawn height refers to how high the
    // enemies can spawn above the playfield. The higher
    // it is, the less dense the enemy formations are.
    //
    // It is reduced to make gameplay harder as a match
    // goes on. To make the difficulty more 'dynamic' and
    // less 'brick wall', it will jump back up at random
    // points, if it's below the current 'tolerence'.

    match.spawn_height = ClampI64(match.spawn_height-1, 3000, 12000);

    if (match.spawn_height < match.spawn_tolerence
	&& RandRangeI64(-100,100)==0) {
      match.spawn_height += RandRangeI64(500,1000);
      match.spawn_tolerence -= 400;
    }

    // $TX+IV," Regen player health "$
    if ((player.health < 3) && (match.time - player.last_hit_time > REGEN_TIME)) {
      player.health++;
      // (Not technically hit, but regen is gradual)
      player.last_hit_time = match.time;
    }

    if (frame%1000==0)
      match.big_bullet_interval=ClampI64(match.big_bullet_interval-2,4,100);

    // $TX+IV," Sleep until next frame "$
    Sleep(FRAME_LENGTH - ToI64((tS - frame_time_start)*1000));
    frame++;
  }
  
  main_loop_end:


  // $TX+IV," Update score "$
  // Adds match's score to unused array cell and QSorts the
  // whole thing, storing top TOP_SCORES_NUM. See initialization.

  top_scores[TOP_SCORES_NUM].match_time = current_score.match_time;
  top_scores[TOP_SCORES_NUM].date = current_score.date;



  // $TX+IV," Put date for the new score "$
  Date2Struct(&ds,Now);

  U8 date_str[11];
  StrPrint(date_str,"%d-%02d-%02d",ds.year,ds.mon,ds.day_of_mon);
  StrCpy(current_score.date, date_str);


  // $TX+IV," Sort and write scores to registry "$
  QSort(top_scores,TOP_SCORES_NUM+1,sizeof(Score),&ScoreCompare);

  RegWrite("Rendello/Bull!ts", \
	"Score top_scores[11]={{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},
	{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},
	{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},{%-5.1f,\"%s\"},{0,0}};",
	top_scores[0].match_time,top_scores[0].date,
	top_scores[1].match_time,top_scores[1].date,
	top_scores[2].match_time,top_scores[2].date,
	top_scores[3].match_time,top_scores[3].date,
	top_scores[4].match_time,top_scores[4].date,
	top_scores[5].match_time,top_scores[5].date,
	top_scores[6].match_time,top_scores[6].date,
	top_scores[7].match_time,top_scores[7].date,
	top_scores[8].match_time,top_scores[8].date,
	top_scores[9].match_time,top_scores[9].date
  );

  DCFill(dc);
  DCDel(dc);

  DCDel(dc_2);
}

SettingsPush;
Main;
SettingsPop;
gr.fp_draw_ms=&DrawStdMs;


if (PROFILER) { DocMax; ProfRep; WinMax; }        â©             ª   ÷                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      